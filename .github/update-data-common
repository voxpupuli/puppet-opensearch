#!/usr/bin/env ruby

require 'open-uri'
require 'yaml'

# plugin
#   directory
#     file
plugin_config = {
  notifications: {
    'main/notifications/notifications/src/main': [
      'notifications'
    ],
    'main/notifications/core/src/main': [
      'notifications-core',
    ]
  },
  observability: {
    'main/src/main' => [
      'observability',
    ],
  },
  reporting: {
    'main/src/main' => [
      'reports-scheduler',
    ],
  },
  security: {
    'main' => [
      'action_groups',
      'allowlist',
      'audit',
      'config',
      'internal_users',
      'nodes_dn',
      'roles_mapping',
      'roles',
      'tenants',
    ],
  },
}

hiera_data = YAML.load_file('data/common.yaml')

plugin_config.each do |plugin, directories|
  directories.each do |directory, files|
    files.each do |file|
      puts "#{plugin}/#{file}"
      puts("https://raw.githubusercontent.com/opensearch-project/#{plugin}/#{directory}/config/#{file}.yml")
      data = YAML.load(URI.open("https://raw.githubusercontent.com/opensearch-project/#{plugin}/#{directory}/config/#{file}.yml").read)
      hiera_data["opensearch::default_#{plugin}_#{file}".gsub('-', '_')] = data
    end
  end
end
File.write('data/common.yaml', "# DO NOT EDIT THIS FILE\n# Content was auto-generated with .github/update-data-common\n#{hiera_data.sort.to_h.to_yaml}")
